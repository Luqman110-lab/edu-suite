# Google Cloud Platform (GCP) Migration Guide

This guide details the steps to deploy your application to **Google Cloud Platform** using **Cloud SQL** (Database) and **Cloud Run** (Application Hosting).

---

## Phase 1: Database Setup (Cloud SQL)

1.  **Log in to Google Cloud Console**.
2.  Search for **SQL** (Cloud SQL) and click **Create Instance**.
3.  **Choose database engine**: **PostgreSQL**.
4.  **Configuration**:
    *   **Instance ID**: e.g., `broadway-db`.
    *   **Password**: *[Generate and save a strong password]*.
    *   **Database version**: PostgreSQL 15 (or latest).
    *   **Region**: Choose a region close to your users (e.g., `europe-west1`).
    *   **Zonal availability**: Single zone (Cheaper for dev/test) or Highly Available (Production).
    *   **Machine configuration**: **Shared core** -> `db-f1-micro` (Cheapest option) or `db-g1-small`.
5.  **Connections**:
    *   **Public IP**: Checked.
    *   **Authorized networks**: Add your current IP address (to allow migration from your laptop).
6.  **Create Instance**.
7.  **Wait** for it to finish (can take 5-10 mins).
8.  **Copy the Connection Name** (e.g., `project-id:region:instance-id`).

### Create Database & User
1.  Go to the **Databases** tab -> **Create Database** -> Name it `broadway_db`.
2.  Go to the **Users** tab -> The defaults (`postgres`) are fine, or create a new one.

### Migrate Data to Cloud SQL
From your local machine terminal:
```bash
# Export local schema and data
pg_dump -U postgres -h localhost -d broadway_db > backup.sql

# Import to Cloud SQL
# Note: You need the Public IP of your Cloud SQL instance (found on Overview page)
psql -h <CLOUD_SQL_PUBLIC_IP> -U postgres -d broadway_db -f backup.sql
```

---

## Phase 2: Application Containerization

We use the same `Dockerfile`.

### Push to Google Container Registry (GCR) or Artifact Registry
1.  **Enable Container Registry API** in GCP Console.
2.  **Authenticate & Push** (requires `gcloud` CLI installed):
    ```bash
    # Configure docker to use gcloud credentials
    gcloud auth configure-docker
    
    # Tag and Push
    docker build -t gcr.io/<PROJECT_ID>/broadway-app .
    docker push gcr.io/<PROJECT_ID>/broadway-app
    ```

---

## Phase 3: Deployment (Cloud Run)

1.  Search for **Cloud Run** -> **Create Service**.
2.  **Deploy one revision from an existing container image**.
3.  **Select** the image you just pushed (`gcr.io/.../broadway-app`).
4.  **Service Name**: `broadway-app`.
5.  **Region**: Same as database.
6.  **Authentication**: **Allow unauthenticated invocations** (so the public can visit your website).
7.  **Container, Variables & Secrets**:
    *   **Container Port**: `5000`.
    *   **Environment Variables**:
        *   `NODE_ENV`: `production`
        *   `SESSION_SECRET`: *[Random long string]*
        *   `DATABASE_URL`: `postgres://postgres:<PASSWORD>@<CLOUD_SQL_PUBLIC_IP>:5432/broadway_db`
            *   *Note*: For better security, use the **Cloud SQL Auth Proxy** socket connection string later, but Public IP is easiest for first setup.
8.  **Create**.

---

## Phase 4: Final Steps

1.  Click the **URL** generated by Cloud Run (e.g., `https://broadway-app-xyz-uc.a.run.app`).
2.  Verify the application loads and can access the database.
